<!DOCTYPE html>
<html>
<head>
    <title>Restful Ideone API Sample</title>
    <style>
        .code
        {
            font-family: Consolas, Monaco;
            font-size: 12pt;
        }
        #txtCode 
        {
            width: 640px;
            height: 180px;
        }
        #txtInput
        {
            width: 640px;
            height: 100px;
        }
    </style>

    <script src="scripts/jquery-1.5.1.min.js"></script>
    <script src="scripts/jscex.bundle.min.js"></script>
    <script src="scripts/jscex-bindings.js"></script>
    <script src="scripts/languages.js"></script>
    <script src="scripts/base64.js"></script>

    <script>
        $.ajaxSetup({
            type: "post",
            dataType: "json",
            cache: false,
            beforeSend: function (xhr, options) {
                xhr.setRequestHeader("Authorization", "Basic " + Base64.encode(options.auth));
            }
        });

        var loadSample = function () {
            var languageId = $("#sltLanguages").val();
            var lang = languages[languageId];
            $("#txtCode").val(lang ? lang.source : "");
            $("#txtInput").val(lang ? lang.input : "");
        }

        var Async = Jscex.Async;

        var loadLanguages = eval(Jscex.compile("async", function () {
            try {
                var data = $await($.ajaxAsync({
                    url: "/languages",
                    type: "get",
                    auth: "jeffreyzhaojie:12345678"
                }));

                var sltLanguages = $("#sltLanguages");
                sltLanguages.empty();

                $.each(data, function (key, value) {
                    sltLanguages
                        .append($("<option></option>")
                        .attr("value", key)
                        .text(value));
                });

                $("#btnLoadSample").removeAttr("disabled");
                $("#btnExecute").removeAttr("disabled");
            } catch (ex) {
                if (ex.source != "xhr") throw ex;
                alert("Failed to load languages: " + ex.message);
            }
        }));

        var execute = eval(Jscex.compile("async", function () {

            var auth = $("#txtUserName").val() + ":" + $("#txtPassword").val();
            if (auth.length < 3) {
                alert("Please input the username and password.");
                return;
            }

            $("#btnLoadSample").attr("disabled", "disabled");
            $("#btnExecute").attr("disabled", "disabled");

            var langId = $("#sltLanguages").val();
            var code = $("#txtCode").val();
            var input = $("#txtInput").val();
            var preStatus = $("#preStatus");

            try {
                preStatus.text("Creating submission...");
                var link = $await($.ajaxAsync({
                    url: "/pastes",
                    data: { languageId: langId, sourceCode: code, input: input },
                    auth: auth
                }));

                var status;
                while (true) {
                    status = $await($.ajaxAsync({
                        url: "/paste/" + link + "/status",
                        type: "get",
                        auth: auth
                    }));

                    preStatus.text(status.state);

                    if (status.state == "Done") {
                        break;
                    }

                    $await(Async.sleep(1000));
                }

                var detail = $await($.ajaxAsync({
                    url: "/paste/" + link,
                    type: "get",
                    cache: true,
                    auth: auth
                }));

                var lines = [];
                lines.push("Time: " + detail.time + "s");
                lines.push("Memory: " + detail.memory + "kb");

                if (detail.error) {
                    lines.push("Error: " + detail.error);
                }

                if (detail.compileInfo) {
                    lines.push("Compile Info: " + detail.compileInfo);
                }

                if (detail.output) {
                    lines.push("Output: " + detail.output);
                }

                preStatus.text(lines.join("\n"));
            } catch (ex) {
                if (ex.source != "xhr") throw ex;
                preStatus.text("Failed to execute the code: " + ex.message);
            } finally {
                $("#btnLoadSample").removeAttr("disabled");
                $("#btnExecute").removeAttr("disabled");
            }
        }));

        $(document).ready(function () {
            loadLanguages().start();
        });
    </script>
</head>
<body>
    <p>
        <select id="sltLanguages"><option>Loading...</option></select>
        <input type="button" id="btnLoadSample" value="Load Sample" disabled="disabled" onclick="loadSample();" />
    </p>

    <p>
        Username: <input type="text" id="txtUserName" />
        Password: <input type="password" id="txtPassword" />
        <a href="http://ideone.com/offer/users/" target="_blank">Visit here if you don't know what it is.</a>
    </p>

    <p>Code:</p>
    <p><textarea id="txtCode" class="code"></textarea></p>

    <p>Input:</p>
    <p><textarea id="txtInput" class="code"></textarea></p>

    <p>
        <input type="button" id="btnExecute" value="Execute" disabled="disabled" onclick="execute().start();" />
    </p>

    <pre id="preStatus" class="code">(... status shows here ...)</pre>

    <p>This page uses <a href="http://ideone.com">ideone.com</a> &copy; by <a href="http://sphere-research.com">Sphere Research Labs</a></p>
</body>
</html>
