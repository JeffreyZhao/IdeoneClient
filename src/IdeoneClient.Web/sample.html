<!DOCTYPE html>
<html>
<head>
    <title>Sample</title>
    <style>
        #code, #output
        {
            width: 640px;
            height: 180px;
            font-family: Consolas, Monaco;
            font-size: 12pt;
        }
    </style>

    <script src="scripts/jquery-1.5.1.min.js"></script>
    <script src="scripts/jscex.bundle.min.js"></script>
    <script src="scripts/jscex-bindings.js"></script>
    <script src="scripts/languages.js"></script>
    <script src="scripts/base64.js"></script>

    <script>
        $.ajaxSetup({
            type: "post",
            dataType: "json",
            cache: false,
            beforeSend: function (xhr, options) {
                xhr.setRequestHeader("Authorization", "Basic " + Base64.encode(options.auth || "username:password"));
            }
        });

        var loadSample = function () {
            var languageId = $("#sltLanguages").val();
            var lang = languages[languageId];
            $("#code").val(lang ? lang.source : "");
        }

        var write = function (s) {
            var o = $("#output");
            o.val(o.val() + s);

            o.scrollTop(o[0].scrollHeight);
        }

        var Async = Jscex.Async;

        var loadLanguages = eval(Jscex.compile("async", function () {
            try {
                var data = $await($.ajaxAsync({
                    url: "/languages",
                    type: "get",
                    auth: "jeffreyzhaojie:12345678"
                }));

                var sltLanguages = $("#sltLanguages");
                sltLanguages.empty();

                $.each(data, function (key, value) {
                    sltLanguages
                    .append($("<option></option>")
                    .attr("value", key)
                    .text(value));
                });

                $("#btnLoadSample").removeAttr("disabled");
                $("#btnExecute").removeAttr("disabled");
            } catch (ex) {
                alert("Failed to load languages: " + ex.message);
                return;
            }
        }));

        var execute = eval(Jscex.compile("async", function () {
            try {
                var languageId = $("#sltLanguages").val();
                var code = $("#code").val();

                write("Creating submission: ");
                var link = $await($.ajaxAsync({
                    url: "/pastes",
                    data: { languageId: $("#sltLanguages").val(), sourceCode: $("#code").val() }
                }));
                write(link + "\n");

                var status;
                while (true) {
                    status = $await($.ajaxAsync({ url: "/paste/" + link + "/status", type: "get" }));
                    write(status.state + "\n");

                    if (status.state == "Done") {
                        break;
                    }

                    $await(Async.sleep(1000));
                }

                var detail = $await($.ajaxAsync({ url: "/paste/" + link, type: "get", cache: true }));
                write("Time: " + detail.time + "s\n");
                write("Memory: " + detail.memory + "kb\n");

                if (detail.error) {
                    write("Error: " + detail.error + "\n");
                }

                if (detail.compileInfo) {
                    write("Compile Info: " + detail.compileInfo + "\n");
                }

                if (detail.output) {
                    write("Output: " + detail.output + "\n");
                }
            } catch (ex) {
                debugger;
            }
        }));

        $(document).ready(function () {
            loadLanguages().start();
        });
    </script>
</head>
<body>
    <p>
        <select id="sltLanguages"><option>Loading...</option></select>
        <input type="button" id="btnLoadSample" value="Load Sample" disabled="disabled" onclick="loadSample();" />
        <input type="button" id="btnExecute" value="Execute" disabled="disabled" onclick="execute().start();" />
    </p>

    <p>Code:</p>
    <p><textarea id="code"></textarea></p>

    <p>Output:</p>
    <p><textarea id="output"></textarea></p>

    <p>This page uses <a href="http://ideone.com">ideone.com</a> &copy; by <a href="http://sphere-research.com">Sphere Research Labs</a></p>
</body>
</html>
